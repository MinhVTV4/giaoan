<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic MVP - Gemini Developer API (1.5 Flash)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        #controls { margin-bottom: 20px; }
        #promptInput { width: 70%; padding: 10px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #responseContainer { margin-top: 20px; padding: 15px; border: 1px solid #ddd; background-color: #fff; border-radius: 4px; min-height: 100px; white-space: pre-wrap; } /* pre-wrap để giữ định dạng xuống dòng */
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Thử nghiệm Firebase AI Logic với Gemini Developer API (Model: gemini-1.5-flash-latest)</h1>

    <div id="controls">
        <textarea id="promptInput" rows="3" placeholder="Nhập lời nhắc của bạn ở đây... ví dụ: Kể một câu chuyện ngắn về một con rồng thân thiện."></textarea>
        <button id="sendPromptButton">Gửi yêu cầu tới Gemini</button>
    </div>
    
    <h2>Phản hồi từ Gemini:</h2>
    <div id="responseContainer">Chưa có phản hồi...</div>

    <script type="module">
      // 1. Import các hàm cần thiết từ Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      // **QUAN TRỌNG VỀ IMPORT MODULE 'firebase/ai' QUA CDN:**
      // Nếu dòng import dưới đây gây lỗi "fetch-error" hoặc các lỗi liên quan đến module,
      // bạn RẤT NÊN chuyển sang sử dụng npm và một bundler (như Vite).
      import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-ai.js";

      // 2. Cấu hình Firebase của bạn
      const firebaseConfig = {
        apiKey: "AIzaSyAnWoc5pBabK2OfFeCau61X1PioBR5gBD8", // **QUAN TRỌNG: Hãy thay thế bằng API key thực của bạn từ Firebase Console.**
        authDomain: "ailab-9ef87.firebaseapp.com",
        projectId: "ailab-9ef87",
        storageBucket: "ailab-9ef87.appspot.com", // Kiểm tra lại tên bucket này trong Firebase Console
        messagingSenderId: "558122624068",
        appId: "1:558122624068:web:bde003000c6568f5e74811"
      };

      // 3. Khởi tạo Firebase App
      const app = initializeApp(firebaseConfig);
      console.log("Firebase App initialized!");
      document.getElementById("responseContainer").innerHTML = "Firebase App đã khởi tạo.<br>Đang chờ khởi tạo AI Model...";

      // 4. Khởi tạo dịch vụ Gemini Developer API và tạo một thực thể mô hình Gemini.
      let model;
      try {
        const ai = getAI(app, { backend: new GoogleAIBackend() });
        
        // *** THAY ĐỔI MODEL NAME Ở ĐÂY ***
        model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" }); 
        
        console.log("Generative Model instance created with model 'gemini-1.5-flash-latest'!");
        document.getElementById("responseContainer").innerHTML += "<br>Generative Model instance đã tạo với model 'gemini-1.5-flash-latest'!";
      } catch (e) {
        console.error("Lỗi khi khởi tạo AI Model:", e);
        document.getElementById("responseContainer").innerHTML = `<span class="error">Lỗi khởi tạo AI Model: ${e.message}.<br>Hãy kiểm tra Console (F12) để biết chi tiết.<br>Đảm bảo module 'firebase/ai.js' được tải đúng và Gemini API đã được kích hoạt trong Firebase project của bạn cho model này.</span>`;
      }
      
      // 5. Hàm gửi yêu cầu và hiển thị phản hồi
      async function callGeminiAPI() {
        if (!model) {
          document.getElementById("responseContainer").innerText = "Mô hình AI chưa được khởi tạo. Hãy kiểm tra lỗi ở Console (F12).";
          return;
        }

        const promptText = document.getElementById("promptInput").value;
        if (!promptText.trim()) {
            alert("Vui lòng nhập lời nhắc!");
            return;
        }

        document.getElementById("responseContainer").innerText = "Đang gửi yêu cầu đến Gemini...";
        console.log("Sending prompt:", promptText);

        try {
          const result = await model.generateContent(promptText);
          const response = await result.response;
          const text = response.text();
          
          document.getElementById("responseContainer").innerText = text;
          console.log("Response text:", text);
        } catch (error) {
          console.error("Lỗi khi gọi Gemini API:", error);
          // Lỗi "fetch-error" bạn gặp trước đó thường rơi vào đây.
          document.getElementById("responseContainer").innerHTML = `<span class="error">Lỗi khi gọi Gemini API: ${error.message} (code: ${error.code}).<br>Kiểm tra Console (F12) và tab Network để biết thêm chi tiết.<br>Nguyên nhân có thể do: cấu hình Firebase/API key, model name không đúng/không khả dụng, vấn đề mạng, hoặc hạn chế của việc dùng SDK qua CDN.</span>`;
        }
      }

      // 6. Gán sự kiện cho nút bấm
      const sendButton = document.getElementById("sendPromptButton");
      if (sendButton) {
          sendButton.addEventListener("click", callGeminiAPI);
      } else {
          console.error("Không tìm thấy nút 'sendPromptButton'.");
      }

    </script>
</body>
</html>
